---
title: "INFO 201 Group Project Final No Code"
author: "Rowan Saunders, William Wang, Gianna Lampert, Katharina Cheng"
date: "2023-12-04"
output: html_document
---

```{r, echo = FALSE}
# Adding the data to the RMarkdown file.
library(tidyverse)
race <- read.csv("Washington State Drug Overdose Monthly Updates (1).csv")
drugs <- read.csv("overdose.csv")
```

Below is a table that shows each race's proportion (otherwise known as percentage) to the overall population of Washington state. The overall population was produced from the 2020 Census Bureau data.

```{r, echo = FALSE}

## All of the very inefficient code below is just to better organize the data :')
census2020 <- read.csv("DECENNIALDHC2020.P9-2023-12-02T193216.csv")
census2020 <- census2020 %>% 
  pivot_wider(names_from = "Label..Grouping.", values_from = "Washington") %>% 
  select(c(2, 5:10)) %>% 
  pivot_longer(c(1:7), names_to = "Race", values_to = "Count")

census2020$Count <- as.numeric(gsub(",", "", census2020$Count))

census2020 <- census2020 %>% 
  pivot_wider(names_from = "Race", values_from = "Count")

census2020$Other = census2020[[6]] + census2020[[7]]
census2020 <- census2020 %>% 
 select(c(1:5, 8))

# Calculates the percentage of each race group to the total population of the United States. We use the 2020 Census Bureau for the total population number.
colnames(census2020) <- c("Hispanic", "White", "Black", "AIAN", "Asian", "Other")
census2020_perc <- census2020 %>% 
  pivot_longer(c(1:6), names_to = "Race", values_to = "Count") %>% 
  mutate(CountPercentage = Count / sum(census2020)) %>% 
  select(Race, CountPercentage)

census2020_perc

```
Below captures all of the data for our drugs dataset. It captures all data from 2018 through the first Quarter of 2022. This data was retrieved from the Washington State Department of Health and captures the total number of drug overdoses across the state (without regard to race) for each Quarter of the relevant Years. Rather than include a sample, we have included all data below.

```{r, echo = FALSE}
# Creating a new data table, which includes the Year, the Quarter of that Year (in dbl), the county, and the total count for that county.
newDrugsTable <- drugs %>% 
  mutate(Quarter = as.numeric(substr(year_quarter, 7, 7))) %>%
  select(year, Quarter, geography, count) %>% 
  filter(count != "suppressed", count != 0, geography == "Statewide", year > 2017) %>% 
  group_by(year, Quarter) %>% 
  mutate(count = sum(as.numeric(count))) %>% 
  distinct(year, Quarter, geography, count) %>% 
  arrange(year) %>% 
  pivot_wider(names_from = "geography", values_from = "count")

colnames(newDrugsTable) <- c("Year", "Quarter", "StatewideTotal")
newDrugsTable
```

Below is the final dataset, which merges two datasets, which combines time (quaters and Years) and races. This is the condensed data that we have created from our two datasets, and is most of the data that will be used.

```{r, echo = FALSE}
# This is the "final dataset" that we do end up using, but we will compare it later to the US Census Bureau dataset

# Here, we create a new table that makes the Quarter compatible with the other dataset. Selects only necessary data.
newRaceTable <- race %>% 
  mutate(Quarter = as.numeric(substr(quarter, 2, 2))) %>%
  select(year, Quarter, race, count) %>% 
  pivot_wider(names_from = "race", values_from = "count")

colnames(newRaceTable) <- c("Year", "Quarter", "AIAN", "Asian", "Black", "Hispanic", "White", "Other")

# Joins the newRaceTable and the newDrugsTable.
finalDF <- left_join(newDrugsTable, newRaceTable, by = join_by(Year, Quarter))

# Here is all of our data! There's not a lot of it, which is why we've shown all of it rather than using head() or tail() or sample_n().
finalDF
```

Below shows the total number of drug overdoses that have occurred in Washington State between 2017 and the second Quarter of 2022 for several race groupings. This only accounts for the total number of drug overdoses per each race. Therefore, although the race grouping of "White" has far higher numbers of overdoses, it can only describe the number of overdoses total, and disregards the differences in populations between different racial groups. It makes sense that they have the highest number of overdoses because they are the majority racial population in Washington state.

```{r, echo = FALSE}
# Shows the total number of drug overdoses in Washington state from 2017-2022 for several race groupings.
finalDF
finalDF %>% 
  pivot_longer(!c("Year", "Quarter"), names_to = "Grouping", values_to = "Count") %>%
  mutate(YearQuarter = Year + Quarter / 4) %>% 
  filter(Grouping != "StatewideTotal", Year <= 2022.25) %>% 
  ggplot(aes(YearQuarter, Count, col = factor(Grouping))) +
  scale_y_log10() +
  geom_point() +
  geom_line() +
  labs(
    title = "Number of Drug Overdose Deaths in Washington State",
    x = "Quarter of the Year",
    y = "Overdoses",
    col = "Race"
  )
  
```

Below is a graph that shows the number of overdoses that have occurred for each race grouping in proportion to the total population of their ethnicity in Washington state between 2017 and the second Quarter of 2022. `0.0` is the baseline, and all graphs that are above `0.0` are considered races that have been disproportionally affected by overdoses in Washington state. In the graph below, races "White," "Hispanic," and "Asian" have experienced a disproportionate number of drug overdoses compared to their overall populations in Washington state in the first and second Quarters of 2022.

```{r, echo = FALSE}
finalDF %>% 
  mutate(Quarter = Year + (Quarter / 4)) %>% 
  mutate(Asian = as.numeric(census2020_perc[5, 2]) - Asian / StatewideTotal) %>% 
  mutate(AIAN = as.numeric(census2020_perc[4, 2]) - AIAN / StatewideTotal) %>% 
  mutate(Black = as.numeric(census2020_perc[3, 2]) - Black / StatewideTotal) %>% 
  mutate(Hispanic = as.numeric(census2020_perc[1, 2]) - Hispanic / StatewideTotal) %>% 
  mutate(White = as.numeric(census2020_perc[2, 2]) - White / StatewideTotal) %>% 
  mutate(Other = as.numeric(census2020_perc[6, 2]) - Other / StatewideTotal) %>% 
  pivot_longer(!c("Year", "Quarter", "StatewideTotal"), names_to = "Race", values_to = "Percentage") %>% 
  filter(Quarter <= 2022.25) %>% 
  ggplot(aes(Quarter, Percentage, col = factor(Race))) +
  geom_point() +
  geom_line() +
  geom_hline(yintercept = 0, color = "gray") +
  labs(
    title = "Population Proportion Overdose Deviations from Total Racial Population Groupings in WA State",
    x = "Year",
    y = "Population Proportion Discrepancy",
    col = "Race"
  )
```




